<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Lab03-05 - pointerlock controls</title>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            background-color: #ffffff;
            margin: 0;
            overflow: hidden;
            font-family: arial;
        }

        #blocker {

            position: absolute;

            width: 100%;
            height: 100%;

            background-color: rgba(0, 0, 0, 0.5);

        }

        #instructions {

            width: 100%;
            height: 100%;

            display: -webkit-box;
            display: -moz-box;
            display: box;

            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            box-orient: horizontal;

            -webkit-box-pack: center;
            -moz-box-pack: center;
            box-pack: center;

            -webkit-box-align: center;
            -moz-box-align: center;
            box-align: center;

            color: #ffffff;
            text-align: center;

            cursor: pointer;

        }
    </style>
</head>

<body>
    <script src="three.js"></script>
    <script src="PointerLockControls.js"></script>
    <script src="environment.js"></script>
    <script src="misc.js"></script>


    <div id="blocker">

        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br />
            (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
        </div>

    </div>

    <script>

        var camera;
        var controls, time = Date.now();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
        controls = new THREE.PointerLockControls(camera);

        var objects = [];

        var blocker = document.getElementById('blocker');
        var instructions = document.getElementById('instructions');

        // http://www.html5rocks.com/en/tutorials/pointerlock/intro/
        checkPointerLock(controls);
        

        // init();
        var env = new Environment(camera, controls);
        env.addObject(controls.getObject());
        var geometry = new THREE.BoxGeometry(20, 20, 20);

        for (var i = 0, l = geometry.faces.length; i < l; i++) {

            var face = geometry.faces[i];
            face.vertexColors[0] = new THREE.Color().setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
            face.vertexColors[1] = new THREE.Color().setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
            face.vertexColors[2] = new THREE.Color().setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);

        }

        for (var i = 0; i < 500; i++) {

            var material = new THREE.MeshPhongMaterial({ specular: 0xffffff, shading: THREE.FlatShading, vertexColors: THREE.VertexColors });

            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.x = Math.floor(Math.random() * 20 - 10) * 20;
            mesh.position.y = Math.floor(Math.random() * 20) * 20 + 10;
            mesh.position.z = Math.floor(Math.random() * 20 - 10) * 20;
            env.addObject(mesh);

            material.color.setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);

            objects.push(mesh);

        }
        animate();

        document.body.appendChild(env.renderer.domElement);

        function onWindowResize() {

            env.camera.aspect = window.innerWidth / window.innerHeight;
            env.camera.updateProjectionMatrix();

            env.renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function animate() {

            requestAnimationFrame(animate);

            controls.isOnObject(false);

            env.ray.ray.origin.copy(controls.getObject().position);
            env.ray.ray.origin.y -= 10;

            var intersections = env.ray.intersectObjects(objects);

            if (intersections.length > 0) {

                var distance = intersections[0].distance;

                if (distance > 0 && distance < 10) {

                    controls.isOnObject(true);

                }

            }

            controls.update(Date.now() - time);

            env.renderer.render(env.scene, env.camera);

            time = Date.now();

        }

    </script>
</body>

</html>